name: Claude Code Security Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  claude-security-review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Load security review prompt
        id: load-prompt
        run: |
          # Extract PR number from URL
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_NUMBER=$(basename "$PR_URL")

          echo "PR URL: $PR_URL"
          echo "Extracted PR Number: $PR_NUMBER"

          # Read the security review prompt template
          PROMPT_TEMPLATE=$(cat .claude/commands/chrome-extensions-review.md)

          # Replace $ARGS with the PR number
          PROMPT_CONTENT=$(echo "$PROMPT_TEMPLATE" | sed "s|\$ARGS|$PR_NUMBER|g")

          # Output the processed prompt for use in the next step
          echo "SECURITY_REVIEW_PROMPT<<EOF" >> $GITHUB_ENV
          echo "$PROMPT_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Debug - Show expanded prompt
        run: |
          echo "=== Expanded Security Review Prompt ==="
          printf '%s\n' "$SECURITY_REVIEW_PROMPT"
          echo "========================================"

      - name: Run Claude Code Security Review
        id: claude-security-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: ${{ env.SECURITY_REVIEW_PROMPT }}
          claude_args: '--allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'
